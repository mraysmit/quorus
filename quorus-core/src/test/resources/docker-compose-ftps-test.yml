# FTPS (FTP over SSL/TLS) server for integration testing
# Extends delfer/alpine-ftp-server (vsftpd on Alpine) with auto-generated self-signed cert.
# Supports Explicit FTPS via AUTH TLS on port 21 (TLS optional, not forced).
#
# Why not stilliard/pure-ftpd?
#   The stilliard/pure-ftpd:latest image has a glibc malloc() corruption bug on modern
#   Docker/kernel versions, causing the daemon to crash on every incoming connection.
#   The image hasn't been updated in 4+ years.
#
# Manual usage:
#   docker compose -f docker-compose-ftps-test.yml up -d --build
#   # Wait for healthy status, then: ftp testuser:testpass@localhost:2121
#   # For FTPS: connect to localhost:2121, send AUTH TLS to upgrade
#
# Automated usage: Managed by SharedTestContainers / Testcontainers ComposeContainer

networks:
  ftps-test:
    name: quorus-ftps-test
    driver: bridge

services:
  ftps:
    build:
      context: ./ftps-docker
      dockerfile: Dockerfile
    networks:
      ftps-test:
        aliases:
          - ftps-server
    ports:
      - "2121:21"        # Control port - fixed mapping (avoids socat proxy for TLS compat)
      - "30000:30000"    # Passive mode data port - fixed mapping (FTP PASV requires this)
    environment:
      # FTP credentials (delfer/alpine-ftp-server format: name|password)
      USERS: "testuser|testpass"
      # Passive mode: advertise localhost (tests run on Docker host)
      ADDRESS: "127.0.0.1"
      MIN_PORT: "30000"
      MAX_PORT: "30000"
      # Certificate subject (used by ftps-entrypoint.sh)
      TLS_CN: "localhost"
      TLS_ORG: "Quorus Test"
      TLS_C: "GB"
    healthcheck:
      test: ["CMD-SHELL", "nc -z localhost 21 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 5s    # No DH param generation â€” cert gen is sub-second
